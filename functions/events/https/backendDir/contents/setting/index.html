{|@ wrapper |}
{|> header |}

<div class="col0 grid1 gap1">
    <ul>
        {|* targets: targetName: targetValue |}
        {|# targetValue |}
        <li>
            <h2>{| targetName |}</h2>
            <ul class="grid1 gap1 pad1 {| targetName |}">
                {|* targetValue: itemName: itemValue |}
                <li class="grid3 gap1">
                    <label class="col1 cen mid">{| itemName |}</label>
                    <input class="target_item col2 {| itemName |}" type="text" data-default="{| itemValue |}"
                        data-target="{| targetName |}" data-item="{| itemName |}" value="{| itemValue |}">
                </li>
                {|/*|}
            </ul>
        </li>
        {|/#|}
        {|/*|}
    </ul>

    <button class="target_item col1" type="button" id="updateBtn" data-url="/{| backendFirstPath |}/setting-update">update</button>
</div>
{|> footer |}

<script type="module">

    import { Base } from '/{| backendFirstPath |}/base.js';
    var base = Base.init()

    const updateBtnElement = document.querySelector('#updateBtn')

    let processing = false
    updateBtnElement.addEventListener('click', event => {
        
        // processing then can't send request
        if(processing){
            return 
        }
        
        // start processing
        processing = true
        event.currentTarget.disabled = true;
        
        const url = event.currentTarget.dataset.url
        const unique = event.currentTarget.dataset.unique
        const modifiedItems = document.querySelectorAll('._modified')

        // not change then show warnning
        if (modifiedItems.length === 0) {
            base.setNotice('warning', ['Nothing has changed.'])
            processing = false
            event.target.disabled = false;
            return
        }

        // get body from modified items
        const body = {}
        Object.keys(modifiedItems).forEach(key => {
            // element
            const element = modifiedItems[key]

            // if not has object property then add property
            if (!body.hasOwnProperty(element.dataset.target)) {
                body[element.dataset.target] = {}
            }
            body[element.dataset.target][element.dataset.item] = element.value
        })

        // request to server
        base.fetchServer(url, body)
            .then(result => {

                // get type
                const type = result.status ? 'success' : 'warning'

                let messages = []
                result.messages.forEach(message => {

                    // rebuild message
                    messages.push(message.content)

                    // get selector from key
                    let key = message.key
                    const selector = key =! null ? `.${key.replace('.', ' .')}` : false
                    
                    // has selector
                    if(selector){
                        const element = document.querySelector(selector)

                        // status is success
                        if(result.status){
                            // then remove _modified class
                            element.classList.remove('_modified')

                            // get new value from result balues
                            let value = Object.assign({}, result.values)
                            message.key.split('.').forEach(path => {
                               value = value[path.trim()]
                            })

                            // value is array then change to string
                            value = Array.isArray(value) ? value.join(', ') : value

                            // set new value
                            element.value = value

                            // set new value to data dafault
                            element.dataset.default = value

                            // set modifier class success whith clear time
                            base.setModifierClass(element, type, 4000)
                        } else {
                            // set modifier class error or warning
                            base.setModifierClass(element, type)
                        }
                    }
                })

                // set notice
                base.setNotice(type, messages)

                // end process
                processing = false
                event.target.disabled = false;
            })
            .catch(err => {
                base.setNotice('error', [err.message])
                console.log(err)

                // end process
                processing = false
                event.target.disabled = false;
            })
    })
</script>