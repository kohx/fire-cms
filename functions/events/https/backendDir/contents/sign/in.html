{|@ wrapper |}
{|> header |}

<div class="col0 grid1 gap1">

    <div class="grid3 gap1">
        <label class="col1 cen mid">email</label>
        <input class="target_item col2" id="email" type="email" data-default="" value="kohei0728@gmail.com">
        <label class="col1 cen mid">password</label>
        <input class="target_item col2" id="password" type="password" data-default="" value="1072551">
    </div>

    <button class="target_item" id="sign_in_button" class="col1" type="button" data-csrf_token="{|csrfToken|}"
        data-request_url="/{|backendFirstPath|}/sign-in" data-backend_url="{|backendFirstPath|}">signin</button>
</div>
{|> footer |}

<script type="module">

    import { Base } from '/{| backendFirstPath |}/base.js';
    var base = Base.init()
    
    // httpOnly Cookieを使用するため、クライアントの状態を保持しない
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.NONE)

    /* サインイン イベント */
    const signInButton = document.querySelector('#sign_in_button')

    let processing = false
    signInButton.addEventListener('click', (event) => {

        // processing then can't send request
        if(processing){
            return
        }

        // start processing
        processing = true
        event.currentTarget.disabled = true;

        // get datas
        const email = document.querySelector('#email').value
        const passwoard = document.querySelector('#password').value
        const target = event.currentTarget
        const csrfToken = target.dataset.csrf_token
        const requestUrl = target.dataset.request_url
        const backendUrl = target.dataset.backend_url

        signInFunction(email, passwoard, csrfToken, requestUrl)
            .then(result => {
                if (result.status) {
                    // result status is true then send to backend top index
                    window.location.assign(`${window.location.origin}/${backendUrl}`)
                } else {
                    // show
                    base.setNotice('error', [result.message], 'Signin failed')
                    processing = false
                    event.target.disabled = false
                }
            })
            .catch(err => {
                base.setNotice('error', [result.message], 'Signin error')
                processing = false
                event.target.disabled = false
            })
    })

    function signInFunction(email, passwoard, csrfToken, requestUrl) {
        return firebase.auth().signInWithEmailAndPassword(email, passwoard)
            .then(result => {
                const user = result.user
                // セッションCookieを交換するために必要なユーザーのIDトークンを取得
                return user.getIdToken()
                    .then(idToken => {

                        // set body
                        // idTokenとCSRFプロテクトのためのトークン
                        const body = {
                            idToken: idToken,
                            csrfToken: csrfToken
                        }

                        // set header
                        const addHeader = { 'Authorization': 'Bearer ' + idToken }

                        // サーバに問い合わせ
                        return base.fetchServer(requestUrl, body, addHeader)
                    })
            })
            .then(result => {
                // 永続性がNONEに設定されているため、ページのリダイレクトで十分
                firebase.auth().signOut()
                return result
            })
            .then(result => {
                return ({
                    status: result.status,
                    message: result.message
                })
            })
            .catch(err => {
                return ({
                    status: false,
                    message: err.message
                })
            })
    }
</script>